(function(){var host="www.dianomi.com";var last_elapsed=0;var fireStart_done=0;var dvRunningTime;var inViewInterval;var playing=false;var fpLoaded=false;var cfLoaded=false;var videoEnded=false;const observerOptions={threshold:0.5};function hookScriptLoad(script,func){if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"){func();}};}else{script.onload=func;}}
function vastAd(id,vast_url,el,data,document,iframe){var flowplayerCheck=0;function set_time(player,time){player.emit(document.defaultView.flowplayer.events.TIME_UPDATE,time);player.ads&&player.ads.setCurrentTime(time);}
document.defaultView.flowplayer(function(opts,root,api){api.on('mount',function(){console.log("mount event body.height = "+document.body.scrollHeight);iframe.style.height=(document.body.scrollHeight+10)+"px";})});var ads=function(){return[{time:0,adTag:vast_url,outstream:true,restart:false,autoplay:true,},];};function render_ad_player(flowplayer_el){let initLoad=true;let player;try{const elements=[];const divs=document.getElementsByTagName('div');for(let i=0;i<divs.length;i++){elements.push(divs[i]);}
let observer=new IntersectionObserver(function(entries){entries.forEach(function(entry){const isIntersecting=entry.intersectionRatio>observerOptions.threshold;if(initLoad&&isIntersecting){player=(document.defaultView.player=document.defaultView.flowplayer(flowplayer_el,{poster:"https://www.dianomi.com/img/uploads/XZ39ESfrgu-bm-M3Vj2qRQAAAAo.png",title:"Dianomi / Ad",token:"eyJraWQiOiJRalBFNnFzeml4QVoiLCJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJjIjoie1wiYWNsXCI6NixcImlkXCI6XCJRalBFNnFzeml4QVpcIn0iLCJpc3MiOiJGbG93cGxheWVyIn0.fzyS2_0rxGN8Nf-XAUc3CV0sUOskGOM4XR0r2o6zUlMjbSCt1txWXK1o1GkjkfxL2dtPJiUsF4JIqSoQEs5Lcg",ui:document.defaultView.flowplayer.ui.NO_DURATION|document.defaultView.flowplayer.ui.NO_DESCRIPTION|document.defaultView.flowplayer.ui.NO_TITLE|document.defaultView.flowplayer.ui.USE_THIN_CONTROLBAR|document.defaultView.flowplayer.ui.USE_PLAY_3,autoplay:true,muted:true,ima:{ads:ads(),timeout:10000,indicator:false},}));player.ads.on(document.defaultView.flowplayer.AdEvents.IMA_ADAPTER_INIT,function(manager){manager.addEventListener(document.defaultView.google.ima.AdEvent.Type.CLICK,function(){var xhr=new XMLHttpRequest();xhr.open("GET","//"+host+"/cgi-bin/smartads_video_a.pl?c="+data.unique_id,true);xhr.send();});});player.on(document.defaultView.flowplayer.AdEvents.OUTSTREAM_TEARDOWN,function(e){e.preventDefault();});player.on(document.defaultView.flowplayer.AdEvents.AD_BREAK_COMPLETED,function(e){player.setOpts({autoplay:false});player.root.addClass(document.defaultView.flowplayer.states.STARTING);player.root.addClass(document.defaultView.flowplayer.states.TOUCHED);player.ads.setSchedule(ads());player.ads.setCurrentTime(0);});player.on([document.defaultView.flowplayer.events.CLICK,document.defaultView.flowplayer.events.TOUCH_END],function(e){player.root.addClass(document.defaultView.flowplayer.states.WAITING);e.preventDefault();player.ads.resetSchedule(ads());player.ads.setCurrentTime(0);});player.on(document.defaultView.flowplayer.events.WAITING,function(e){setTimeout(function(){player.root.removeClass(document.defaultView.flowplayer.states.WAITING);},0);});player.on(document.defaultView.flowplayer.AdEvents.AD_PROGRESS,function(e){var elapsed=e.data.duration-e.data.remaining;var diff=elapsed-last_elapsed;if(diff>1){var xhr=new XMLHttpRequest();xhr.open("GET","//"+
host+
"/cgi-bin/smartads_video_a.pl?p="+
data.unique_id+
"&t="+
elapsed+
"&d="+
e.data.duration,true);xhr.send();last_elapsed=elapsed;}
if(fireStart_done==0){fireStart(data);fireStart_done=1;}});player.on(document.defaultView.flowplayer.AdEvents.AD_STARTED,function(e){var xhr=new XMLHttpRequest();xhr.open("GET","//"+host+"/cgi-bin/smartads_video_a.pl?s="+data.unique_id,true);xhr.send();});player.on(document.defaultView.flowplayer.AdEvents.AD_COMPLETED,function(e){var xhr=new XMLHttpRequest();xhr.open("GET","//"+host+"/cgi-bin/smartads_video_a.pl?e="+data.unique_id,true);xhr.send();});player.on(document.defaultView.flowplayer.AdEvents.AD_PLAYBACK_ERROR,function(e){console.info(e.message);});set_time(player,0);initLoad=false;}else{player?isIntersecting?player.ads.resume():player.ads.pause():null;}});},observerOptions);elements.forEach(function(element){if(element.className.indexOf('_dianomi_wrapper')>-1||element.className.indexOf('_dianomi-wrapper')>-1||element.className.indexOf('dianomi_video')>-1){observer.observe(element);}});}catch(e){console.log("flowplayer error",e);if(flowplayerCheck++<10){setTimeout(function(){render_ad_player(flowplayer_el);},1000);}else{throw new Error('Flowplayer was unable to load');}}}
if("google"in document.defaultView){header=make_header(data);footer=make_footer(data);el.appendChild(header);var video_el=document.createElement("div");el.appendChild(video_el);el.appendChild(footer);render_ad_player(video_el);make_openclose(video_el,iframe);}
iframe.style.height=(document.body.scrollHeight+10)+"px";}
function videoAd(id,el,data){console.log("videoAd id",id,"el",el,"data",data);var intersectionObserverScript=document.createElement("script");intersectionObserverScript.type="text/javascript";intersectionObserverScript.src="https://www.dianomi.com/js/intersection-observer.js";document.head.appendChild(intersectionObserverScript);hookScriptLoad(intersectionObserverScript,function(){console.log('IO Script Loaded');});var iframe=document.createElement("iframe");iframe.style.width="100%";iframe.style.height="0px";iframe.style.display="block";iframe.style.border="none";iframe.setAttribute("name",id+"_iframe");iframe.id=id+"_iframe";iframe.setAttribute("allow","accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture");el.appendChild(iframe);setTimeout(function(){var bodyDiv=document.createElement("div");bodyDiv.id="dv_"+id;bodyDiv.className="dianomi_video";var iframeDocument=iframe.contentWindow.document;iframeDocument.body.appendChild(bodyDiv);iframeDocument.body.style.margin=0;iframeDocument.body.style.overflow="hidden";if(data.hasOwnProperty("vast_url")&&data.vast_url!==null){console.log("it's flowplayer");vast_init(id,data.vast_url,bodyDiv,data,iframeDocument,function(){console.log("vast_init done rendering ad");vastAd(id,data.vast_url,bodyDiv,data,iframeDocument,iframe);});}else if(data.hasOwnProperty("cloudflare_stream_id")){console.log("It's cloudflare");cloudflare_realAd(id,bodyDiv,data,iframeDocument,iframe);}else{console.log("Don't know what it is");}},1000);}
function videoElement(el){var done=el.getAttribute("data-dianomi-video-done");if(done&&done==="1"){return;}
var id=el.getAttribute("data-dianomi-video-id");var name=el.getAttribute("data-dianomi-cf-name");var hostparam=el.getAttribute("data-dianomi-video-host");if(hostparam!==undefined&&hostparam!==null){host=hostparam;}
var xmlHttpRequest=new XMLHttpRequest();var url="//"+host+"/cgi-bin/smartads_video_json.pl?id="+id;if(name){url+="&cf="+name;}
xmlHttpRequest.open("GET",url,true);xmlHttpRequest.withCredentials=true;xmlHttpRequest.onreadystatechange=function(){if(xmlHttpRequest.readyState!=4||xmlHttpRequest.status!=200)
return;videoAd(id,el,JSON.parse(xmlHttpRequest.responseText));};el.setAttribute("data-dianomi-video-done","1");xmlHttpRequest.send();}
function init(){var isIE=navigator.userAgent.indexOf("MSIE")>-1||navigator.userAgent.indexOf("rv:11")>-1;if(isIE){console.log('Not compatiable with Internet Explorer');return;}
var videoElements=document.querySelectorAll(".dianomi_video");for(var i=0;i<videoElements.length;i++){videoElement(videoElements[i]);}}
function vast_init(id,url,el,data,document,callback){console.log("vast_init called for id ",id);if(fpLoaded){console.log("vast_init Already loaded, callback() time");return callback();}
var stylesheet=document.createElement("link");stylesheet.rel="stylesheet";stylesheet.href="//cdn.flowplayer.com/releases/native/stable/style/flowplayer.css";document.head.appendChild(stylesheet);addCss("//"+host+"/partner/dianomi/css/dianomi-video.css?v=2.19b",document);var flowPlayerLoaded=false;var pluginsLoaded=false;var imaLoaded=false;function allLoaded(){return flowPlayerLoaded&&pluginsLoaded&&imaLoaded;}
var flowPlayerScript=document.createElement("script");flowPlayerScript.type="text/javascript";flowPlayerScript.defer=true;flowPlayerScript.src="//cdn.flowplayer.com/releases/native/stable/flowplayer.min.js";hookScriptLoad(flowPlayerScript,function(){flowPlayerLoaded=true;if(allLoaded()){fpLoaded=true;callback();}});document.head.appendChild(flowPlayerScript);var pluginScript=document.createElement("script");pluginScript.type="text/javascript";pluginScript.src="//cdn.flowplayer.com/releases/native/stable/plugins/ads.min.js";hookScriptLoad(pluginScript,function(){pluginsLoaded=true;if(allLoaded()){fpLoaded=true;callback();}});document.head.appendChild(pluginScript);var imaScript=document.createElement("script");imaScript.type="text/javascript";imaScript.src="//imasdk.googleapis.com/js/sdkloader/ima3.js";hookScriptLoad(imaScript,function(){imaLoaded=true;if(allLoaded()){fpLoaded=true;callback();}});document.body.appendChild(imaScript);}
function fireStart(data,document){if(data.tracking_pixel_urls){data.tracking_pixel_urls.forEach(function(tracker){var img=document.createElement("img");img.setAttribute("src",tracker);img.setAttribute("style","display:none");document.body.appendChild(img);});}else if(data.start_video_tracker){var img=document.createElement("img");img.setAttribute("src",data.start_video_tracker);img.setAttribute("style","display:none");document.body.appendChild(img);}}
function addCss(fileName,document){var head=document.head;var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=fileName;head.appendChild(link);}
function isInViewport(elem,document){if(elem){var dianomiVideo=elem.getBoundingClientRect();var width=window.innerWidth||document.documentElement.clientWidth;var height=window.innerHeight||document.documentElement.clientHeight;var left=Math.max(0,dianomiVideo.left);var right=Math.min(width,dianomiVideo.right);var bottom=Math.max(-height,-dianomiVideo.bottom);var top=Math.min(0,-dianomiVideo.top);var intersection=left<right&&bottom<top;var area=intersection?(right-left)*(top-bottom):0;var video_area=(dianomiVideo.right-dianomiVideo.left)*(dianomiVideo.bottom-dianomiVideo.top);var percentage=(area/video_area)*100;console.log("isInViewport",percentage>50);return percentage>50;}
return false;}
function cloudflare_getStream(id,document){var elementId="dianomi-video_"+id;return document.getElementById(elementId);}
function onPause(){dvRunningTime=clearInterval(dvRunningTime);}
function toggleMute(video_id,video_el,document){var unmute=video_el.querySelectorAll(".unmute")[0];var mute=video_el.querySelectorAll(".mute")[0];var dianomiStream=cloudflare_getStream(video_id,document);if(dianomiStream.muted){dianomiStream.muted=false;unmute.style.display="block";mute.style.display="none";}else{dianomiStream.muted=true;mute.style.display="block";unmute.style.display="none";}}
function togglePlayP(video_id,video_el,document){var videoElement=cloudflare_getStream(video_id,document);var PauseBtn=video_el.querySelectorAll(".pause")[0];var PlayBtn=video_el.querySelectorAll(".play")[0];if(playing===false){videoElement.play();playing=true;PlayBtn.style.display="none";PauseBtn.style.display="block";}else{videoElement.pause();playing=false;PauseBtn.style.display="none";PlayBtn.style.display="block";}}
function onPlaying(video_id,data,document){videoEnded=false;if(dvRunningTime){clearInterval(dvRunningTime);}
var dianomiVideo=cloudflare_getStream(video_id,document);dvRunningTime=setInterval(function(){var dianomiVideo=cloudflare_getStream(video_id,document);var play_time=dianomiVideo.currentTime;var duration=dianomiVideo.duration;var xhr=new XMLHttpRequest();xhr.open("GET","//"+
host+
"/cgi-bin/smartads_video_a.pl?p="+
data.unique_id+
"&t="+
play_time+
"&d="+
duration,true);xhr.send();},2000);var progress=document.getElementById("dianomiDuration");progressBarWidth=setInterval(function(){if(dianomiVideo){var play_time=dianomiVideo.currentTime;var duration=dianomiVideo.duration;var progressWidth=((play_time/duration)*100).toFixed(2);progress.style.width=progressWidth+"%";}},100);}
function DVonLoad(video_el,video_id,data,document){function tabChange(event){var dianomiStream=cloudflare_getStream(video_id,document);var inV=isInViewport(dianomiStream);window.onblur=function(){var dianomiStream=cloudflare_getStream(video_id,document);if(dianomiStream){dianomiStream.pause();dvRunningTime=clearInterval(dvRunningTime);}};window.onfocus=function(){var dianomiStream=cloudflare_getStream(video_id,document);if(inV&&dianomiStream.paused){dianomiStream.play();}};}
function togglePause(video_id,video_el,document,intersecting){var videoElement=cloudflare_getStream(video_id,document);var PauseBtn=video_el.querySelectorAll(".pause")[0];var PlayBtn=video_el.querySelectorAll(".play")[0];if(playing===false&&!videoEnded&&intersecting){videoElement.play();playing=true;PlayBtn.style.display="none";PauseBtn.style.display="block";setTimeout(function(){if(videoElement.paused){videoElement.play();}},1000);}else{videoElement.pause();playing=false;PauseBtn.style.display="none";PlayBtn.style.display="block";}}
video_el.querySelectorAll(".play")[0].addEventListener("click",function(){togglePlayP(video_id,video_el,document);},false);video_el.querySelectorAll(".pause")[0].addEventListener("click",function(){inViewInterval=clearInterval(inViewInterval);togglePlayP(video_id,video_el,document);},false);video_el.querySelectorAll(".mute")[0].addEventListener("click",function(){toggleMute(video_id,video_el,document);},false);video_el.querySelectorAll(".unmute")[0].addEventListener("click",function(){toggleMute(video_id,video_el,document);},false);document.addEventListener("visibilitychange",tabChange);const divs=document.getElementsByTagName('div');const elements=[];for(let i=0;i<divs.length;i++){elements.push(divs[i]);}
let observer=new IntersectionObserver(function(entries){entries.forEach(function(entry){var v=cloudflare_getStream(video_id,document);if(v){const isIntersecting=entry.intersectionRatio>observerOptions.threshold;if(isIntersecting&&v.paused){togglePause(video_id,video_el,document,isIntersecting);if(dvRunningTime){clearInterval(dvRunningTime);}
dvRunningTime=setInterval(function(){var play_time=v.currentTime;var xhr=new XMLHttpRequest();xhr.open("GET","//"+
host+
"/cgi-bin/smartads_video_a.pl?p="+
data.unique_id+
"&t="+
play_time,true);xhr.send();},5000);var xhr=new XMLHttpRequest();xhr.open("GET","//"+host+"/cgi-bin/smartads_video_a.pl?s="+data.unique_id,true);xhr.send();fireStart(data);}else{togglePause(video_id,video_el,document,isIntersecting);}}});},observerOptions);elements.forEach(function(element){if(element.className.indexOf('_dianomi_wrapper')>-1||element.className.indexOf('_dianomi-wrapper')>-1||element.className.indexOf('dianomi_video')>-1){observer.observe(element);}});}
function onEnd(data){videoEnded=true;dvRunningTime=clearInterval(dvRunningTime);var xhr=new XMLHttpRequest();xhr.open("GET","//"+host+"/cgi-bin/smartads_video_a.pl?e="+data.unique_id,true);xhr.send();}
function setListeners(video_id,data,document){var dianomiStream=cloudflare_getStream(video_id,document);if(dianomiStream){dianomiStream.addEventListener("play",function(){onPlaying(video_id,data,document);});dianomiStream.addEventListener("ended",function(){onEnd(data);});dianomiStream.addEventListener("pause",onPause);}}
function cloudflare_realAd(video_id,video_el,data,document,iframe){var dianomiStream=document.createElement("stream");dianomiStream.id="dianomi-video_"+video_id;dianomiStream.className="dianomi-video";dianomiStream.setAttribute("src",data.cloudflare_stream_id);dianomiStream.setAttribute("mute","mute");dianomiStream.setAttribute("width","100%");dianomiStream.setAttribute("preload","preload");dianomiStream.muted=true;video_el.appendChild(dianomiStream);cloudflare_init(video_id,video_el,data,function(){cloudflare_videoInit(video_id,data,video_el,document,iframe);},document,iframe);}
function cloudflare_videoInit(video_id,data,video_el,document,iframe){var progressBar=document.createElement("div");progressBar.id="dianomiProgressBar";progressBar.innerHTML='<div id="dianomiDuration"></div>';var ClsBtn=document.createElement("button");ClsBtn.setAttribute("class","openclose");ClsBtn.innerHTML="&times;";ClsBtn.id="openclose_"+video_id;var UMuBtn=document.createElement("button");UMuBtn.setAttribute("class","unmute");UMuBtn.setAttribute("style","display:none;");UMuBtn.innerHTML='<img src="//'+
host+
'/img/icons/Speaker_Icon.svg" width=20 height=20/>';UMuBtn.id="unmute_"+video_id;var MuBtn=document.createElement("button");MuBtn.setAttribute("class","mute");MuBtn.innerHTML='<img src="//'+host+'/img/icons/Mute_Icon.svg" width=20 height=20/>';MuBtn.id="mute_"+video_id;var PlayBtn=document.createElement("button");PlayBtn.setAttribute("class","playpause play");PlayBtn.setAttribute("style","position: absolute: left: 0; display: none; font-family: arial, helvetica ,sans-serif; letter-spacing: 0.5px;");PlayBtn.innerHTML="&#9658;";PlayBtn.id="PlayBtn_"+video_id;var PauseBtn=document.createElement("button");PauseBtn.setAttribute("class","playpause pause");PauseBtn.setAttribute("style","position: absolute: left: 0; font-family: arial, helvetica ,sans-serif; letter-spacing: 0.5px;");PauseBtn.innerHTML="&#2405;";PauseBtn.id="PauseBtn_"+video_id;video_el.appendChild(progressBar);video_el.appendChild(ClsBtn);video_el.appendChild(UMuBtn);video_el.appendChild(MuBtn);video_el.appendChild(PlayBtn);video_el.appendChild(PauseBtn);video_el.style.maxHeight="600px";video_el.classList.add("dianomiVideoWrapper");console.log(video_id);var exit=false;ClsBtn.addEventListener("click",function(e){if(exit==false){e.preventDefault();video_el.style.maxHeight="0px";video_el.style.padding="0px";setTimeout(function(){video_el.remove();iframe.style.height="0px";},800);if(dvRunningTime){clearInterval(dvRunningTime);}
return false;}});function isMobileVideo(){return(typeof window.orientation!=="undefined"||navigator.userAgent.indexOf("IEMobile")!==-1);}
if(isMobileVideo()){let click=false;video_el.addEventListener("touchstart",function(e){click=true;});video_el.addEventListener("touchend",function(e){var tagName=e.target.tagName;if(click&&tagName==="VIDEO"){window.open(data.link);}else{return;}});video_el.addEventListener("touchmove",function(e){click=false;});}else{video_el.addEventListener("click",function(e){var tagName=e.target.tagName;if(tagName!=="VIDEO"){return;}else{window.open(data.link);}});}
DVonLoad(video_el,video_id,data,document);setListeners(video_id,data,document);var dianomiStream=cloudflare_getStream(video_id,document);var inV=isInViewport(dianomiStream);if(inV&&dianomiStream){dianomiStream.play();var xhr=new XMLHttpRequest();xhr.open("GET","//"+host+"/cgi-bin/smartads_video_a.pl?s="+data.unique_id,true);xhr.send();fireStart(data,document);}
iframe.style.height=(document.body.scrollHeight+10)+"px";}
function make_header(data){var clientImageTag=data.advertiser_image?'<img style="padding: 5px;" height=30 src='+
data.advertiser_image+
">":"";var clientText='<div class="dianomi-header-text" height="50"><span>'+data.sponsored_text+' &nbsp;'+
clientImageTag+
"</span></div>";var clientnoImgText='<div class="dianomi-header-text blank-header" height="50"></div>';var mainText='<div class="dianomi-main-text"><a href="'+
data.link+
'" target="_blank">'+
data.advertiser_text+
"</a></div>";var ctaText='<div class="dianomi-cta-text"><a href="'+
data.link+
'" target="_blank">'+
data.advertiser_call_to_action+
"</a></div>";var poweredBy='<div style="float:right">Video Ad by <img src="//'+
host+
'/img/dianomi-max-200x38.png" width=50 height=10/></div>';var header=document.createElement("div");header.className="dianomi-text-wrapper";if(data.advertiser_image){header.innerHTML+=clientText;}
if(data.advertiser_image===undefined&&(data.advertiser_text||data.advertiser_call_to_action)){header.innerHTML+=clientnoImgText;}
if(data.advertiser_text){header.innerHTML+=mainText;}
if(data.advertiser_call_to_action){header.innerHTML+=ctaText;}
return header;}
function make_footer(data){var poweredBy='<div style="float:right">Video Ad by <img src="//'+
host+
'/img/dianomi-max-200x38.png" width=50 height=10/></div>';var footer=document.createElement("div");footer.className="sub-line2";footer.innerHTML+=poweredBy;return footer;}
function make_openclose(video_el,iframe){var ClsBtn=document.createElement("button");ClsBtn.setAttribute("class","openclose");ClsBtn.innerHTML="&times;";video_el.parentElement.appendChild(ClsBtn);var exit=false;ClsBtn.addEventListener("click",function(e){if(exit==false){e.preventDefault();video_el.style.maxHeight="0px";video_el.parentElement.style.height="0px";video_el.parentElement.style.padding="0px";setTimeout(function(){video_el.parentElement.remove();iframe.style.height="0px";},800);if(dvRunningTime){clearInterval(dvRunningTime);}
return false;}});}
function cloudflare_init(id,video_el,data,callback,document,iframe){header=make_header(data);footer=make_footer(data);video_el.insertBefore(header,video_el.firstChild);video_el.appendChild(footer);if(cfLoaded){return callback();}
var script=document.createElement("script");script.type="text/javascript";script.defer=true;script.src="https://embed.videodelivery.net/embed/r4xu.fla9.latest.js?video="+
data.cloudflare_stream_id;hookScriptLoad(script,function(){cfLoaded=true;callback();});var head=document.getElementsByTagName("head")[0];head.appendChild(script);addCss("//"+host+"/partner/dianomi/css/dianomi-video.css?v=2.19b",document);}
init();})();